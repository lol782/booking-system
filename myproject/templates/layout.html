{% comment %} {% load static tailwind_tags %} {% endcomment %}

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="{% static 'style.css' %}?v=5">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    
{% comment %} {% tailwind_css %} {% endcomment %}

     
</head>
<body>

 <header style="color: white;">
        <nav class="navbar">
            <div class="logo">
                <a href="/">
                    <img src="https://media.geeksforgeeks.org/wp-content/cdn-uploads/gfg_200x200-min.png"
                        alt="gfg_logo">
                </a>
            </div>
            <div class="hamburger-menu">
                <span class="line"></span>
                <span class="line"></span>
                <span class="line"></span>
            </div>
            <div class="nav-menu hide">
               <a href="{% url 'home' %}">Home</a>
                <a href="{% url 'about' %}">About</a>
                <a href="{% url 'contact' %}">Contact</a>
            </div>
            <!-- Offcanvas Trigger Button - Styled as a circle -->
            <button class="btn btn-primary rounded-circle" style="width: 50px; height: 50px; padding: 0;" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                <i class="bi bi-person-fill"></i>
            </button>
        </nav>
    </header>

{% block content %}{% endblock %}

<!-- Offcanvas Body -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasRightLabel">My Account</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    {% if user.is_authenticated %}
      <div class="mb-4">
        Welcome, {{ user.username }}!
      </div>
      <script>
        // Parse token string into separate values
        try {
          const tokenData = {{ access_token|safe }};
          document.write(`
            <input type="hidden" id="userToken" value="${tokenData.access}" />
            <input type="hidden" id="refreshToken" value="${tokenData.refresh}" />
          `);
        } catch (e) {
          console.error('Error parsing tokens:', e);
          document.write(`
            <input type="hidden" id="userToken" value="" />
            <input type="hidden" id="refreshToken" value="" />
          `);
        }
      </script>
      <!-- Debug info (hidden in production) -->
      <div style="display: none;">
        Raw token data: {{ access_token }}
      </div>
      <div class="list-group mb-4">
        <a href="{% url 'mybookings' %}" class="list-group-item list-group-item-action">
          <i class="bi bi-ticket-perforated-fill me-2"></i> My Bookings
        </a>
        <a href="#" class="list-group-item list-group-item-action">
          <i class="bi bi-gear-fill me-2"></i> Account Settings
        </a>
        <form method="post" action="{% url 'logout' %}" class="m-0">
          {% csrf_token %}
          <button type="submit" class="list-group-item list-group-item-action text-danger w-100 text-start">
            <i class="bi bi-box-arrow-right me-2"></i> Logout
          </button>
        </form>
      </div>
    {% else %}
      <div class="mb-4">
        Please login or create an account to manage your bookings.
      </div>
      <div class="d-grid gap-2">
        <a href="{% url 'login' %}" class="btn btn-primary">
          <i class="bi bi-box-arrow-in-right me-2"></i> Login
        </a>
        <a href="{% url 'register' %}" class="btn btn-outline-primary">
          <i class="bi bi-person-plus-fill me-2"></i> Register
        </a>
      </div>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>

<!-- Initialize Bootstrap components -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all offcanvas elements
    var offcanvasElements = document.querySelectorAll('.offcanvas');
    offcanvasElements.forEach(function(element) {
        new bootstrap.Offcanvas(element);
    });
});
</script>

<!-- Chat Widget -->
<div id="chat-widget" class="position-fixed bottom-0 end-0 m-3" style="z-index: 1050;">
    <!-- Chat Toggle Button -->
    <button id="chat-toggle" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center shadow-lg" style="width: 60px; height: 60px;">
        <i class="bi bi-chat-dots-fill fs-4"></i>
    </button>

    <!-- Chat Window -->
    <div id="chat-window" class="card shadow-lg d-none" style="width: 350px; height: 450px; position: absolute; bottom: 70px; right: 0; border-radius: 15px; overflow: hidden;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" style="border-radius: 15px 15px 0 0;">
            <h5 class="mb-0">Chat Support</h5>
            <button type="button" id="chat-close" class="btn-close btn-close-white" aria-label="Close"></button>
        </div>
        <div class="card-body p-0 d-flex flex-column" style="height: calc(100% - 60px);">
            <div id="chat-messages" class="flex-grow-1 p-3" style="overflow-y: auto; max-height: 100%; background-color: #f8f9fa;">
                <!-- Messages will appear here -->
            </div>
            <div class="border-top p-3 bg-white">
                <form id="chat-form" class="d-flex gap-2">
                    <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." style="border-radius: 20px;">
                    <button type="submit" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; min-width: 40px;">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', function() {
    // Debug token presence on page load
    const tokenElement = document.getElementById('userToken');
    const refreshTokenElement = document.getElementById('refreshToken');
    console.log('Tokens on page load:', {
        userTokenExists: !!tokenElement,
        refreshTokenExists: !!refreshTokenElement,
        userTokenValue: tokenElement ? tokenElement.value : 'missing',
        refreshTokenValue: refreshTokenElement ? refreshTokenElement.value : 'missing'
    });

    const chatToggle = document.getElementById('chat-toggle');
    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    const closeButton = document.getElementById('chat-close');

    // Toggle chat window
    chatToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        chatWindow.classList.toggle('d-none');
        if (!chatWindow.classList.contains('d-none')) {
            chatInput.focus();
        }
    });

    // Close chat window
    closeButton.addEventListener('click', () => {
        chatWindow.classList.add('d-none');
    });

    // Close chat window when clicking outside
    document.addEventListener('click', (e) => {
        if (!chatWindow.classList.contains('d-none') &&
            !chatWindow.contains(e.target) &&
            e.target !== chatToggle &&
            !chatToggle.contains(e.target)) {
            chatWindow.classList.add('d-none');
        }
    });

    // Prevent clicks inside chat window from closing it
    chatWindow.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    // Handle message submission
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (!message) return;

        // Add user message to chat
        addMessage(message, 'user');
        chatInput.value = '';
        
        // Show loading message
        const loadingMessage = addMessage('Typing...', 'bot', true);
        // Disable input while processing
        chatInput.disabled = true;
        chatInput.placeholder = 'Please wait...';

        try {
            // Get token elements and debug their presence
            const tokenElement = document.getElementById('userToken');
            const refreshTokenElement = document.getElementById('refreshToken');
            
            console.log('Debug token elements:', {
                tokenElementExists: !!tokenElement,
                refreshTokenElementExists: !!refreshTokenElement,
                tokenValue: tokenElement ? tokenElement.value : 'not found',
                refreshTokenValue: refreshTokenElement ? refreshTokenElement.value : 'not found'
            });
            
            // Check if user is logged in and has valid tokens
            if (!tokenElement || !refreshTokenElement || !tokenElement.value || !refreshTokenElement.value) {
                console.error('Token validation failed:', {
                    tokenExists: !!tokenElement,
                    refreshTokenExists: !!refreshTokenElement,
                    hasTokenValue: !!(tokenElement && tokenElement.value),
                    hasRefreshValue: !!(refreshTokenElement && refreshTokenElement.value)
                });
                throw new Error('Please log in to use the chat (missing tokens)');
            }

            // Get token from hidden input
            let token = tokenElement.value;
            
            // If no access token, try to refresh
            if (!token) {
                const refreshToken = refreshTokenElement.value;
                if (refreshToken) {
                    try {
                        const refreshResponse = await fetch('https://2d59c4f212ad.ngrok-free.app/lol/api/token/refresh/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                refresh: refreshToken
                            })
                        });

                        if (refreshResponse.ok) {
                            const refreshData = await refreshResponse.json();
                            token = refreshData.access;
                            // Update the hidden input with new token
                            document.getElementById('userToken').value = token;
                        } else {
                            throw new Error('Token refresh failed');
                        }
                    } catch (refreshError) {
                        console.error('Token refresh failed:', refreshError);
                        throw new Error('Please log in again to continue chatting');
                    }
                } else {
                    throw new Error('Please log in to use the chat');
                }
            }

            const response = await fetch('https://2dce550080ed.ngrok-free.app/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    user_query: message,
                    token: token  // Also include token in the body as some backends expect it there
                })
            });

            // Remove loading message
            if (loadingMessage && loadingMessage.parentNode) {
                loadingMessage.parentNode.removeChild(loadingMessage);
            }

            if (response.ok) {
                const data = await response.json();
                console.log('API Response:', data);
                
                const botResponse = data.response || data.answer || data.message || data;
                if (typeof botResponse === 'string') {
                    addMessage(botResponse, 'bot');
                } else {
                    console.log('Unexpected response format:', botResponse);
                    addMessage('Received response: ' + JSON.stringify(botResponse), 'bot');
                }
            } else {
                const errorText = await response.text();
                console.error('Response not OK:', {
                    status: response.status,
                    statusText: response.statusText,
                    errorText: errorText
                });
                
                if (response.status === 401 || response.status === 403) {
                    // Token might be expired or invalid
                    document.getElementById('userToken').value = ''; // Clear the token
                    throw new Error('Authentication failed. Please log in again.');
                } else {
                    throw new Error(`Server error (${response.status}): ${errorText || response.statusText}`);
                }
            }
        } catch (error) {
            console.error('Detailed error:', {
                message: error.message,
                stack: error.stack,
                name: error.name
            });
            
            // Remove loading message if it still exists
            if (loadingMessage && loadingMessage.parentNode) {
                loadingMessage.parentNode.removeChild(loadingMessage);
            }

            // Show more specific error messages
            let errorMessage = 'Sorry, I encountered an error. ';
            if (error.message.includes('Authentication failed')) {
                errorMessage += 'Please log in again to continue chatting.';
            } else if (error.message.includes('Server error')) {
                errorMessage += error.message;
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage += 'Could not connect to the chat server. Please check your internet connection.';
            } else {
                // Include the actual error message for debugging
                errorMessage += `Error details: ${error.message}`;
                console.warn('Unhandled error type:', error.message);
            }
            
            addMessage(errorMessage, 'bot');
        } finally {
            // Re-enable input
            chatInput.disabled = false;
            chatInput.placeholder = 'Type your message...';
        }
    });

    function addMessage(text, type, isLoading = false) {
        const div = document.createElement('div');
        div.classList.add('chat-message');
        div.classList.add(type + '-message');
        if (isLoading) {
            div.classList.add('loading');
        }
        div.textContent = text;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return div;
    }

    // Add welcome message
    addMessage('Hello! How can I help you today?', 'bot');
});
</script>
</body>
</html>